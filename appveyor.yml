# Build worker image (VM template)
image: Visual Studio 2019

clone_depth: 5

version: '{build}'

platform: x64

configuration: Release

environment:
  VCPKG_DEFAULT_TRIPLET: "%PLATFORM%-windows-static"
  VCPKG_FEATURE_FLAGS: "manifests"
  #VCPKG_FORCE_SYSTEM_BINARIES: true
  VCPKG_ROOT: "C:\\Tools\\vcpkg"
  MSBUILD_FLAGS: /verbosity:minimal /maxcpucount /p:VcpkgEnableManifest=true
  SW_SDK_SECRET:
    secure: Sb7dCLrPsVPEiu4QKrG8wQ==

cache: c:\tools\vcpkg\installed\

build:
  verbosity: minimal

# scripts that are called at very beginning, before repo cloning
init:
  - date /T & time /T
  - cmake --version
  - msbuild /version
  # Set "build version number" to "short-commit-hash" or when tagged to "tag name" (Travis style)
  - ps: >-
      if ($env:APPVEYOR_REPO_TAG -eq "true")
      {
        Update-AppveyorBuild -Version "$env:APPVEYOR_REPO_TAG_NAME"
      }
      else
      {
        Update-AppveyorBuild -Version "dev-$($env:APPVEYOR_REPO_COMMIT.substring(0,7))"
      }

install:
  # 0) Get Git Submodules: csgo-protobufs
  - git submodule update --init --recursive
  # 1) update vcpkg:
  - cd C:\Tools\vcpkg
  - git pull
  - .\bootstrap-vcpkg.bat -disableMetrics
  - cd C:\projects\csgo-cli
  # 2) update curl to v7.73.0
  #    -> C:\projects\csgo-cli\downloads\curl\curl.exe
  - cd C:\projects\csgo-cli\downloads
  - curl -L -o curl-7.73.0-win64-mingw.zip https://dl.bintray.com/vszakats/generic/curl-7.73.0-win64-mingw.zip
  - 7z x C:\projects\csgo-cli\downloads\curl-7.73.0-win64-mingw.zip -aoa -y -oC:\projects\csgo-cli\downloads
  - del /Q C:\projects\csgo-cli\downloads\curl-7.73.0-win64-mingw.zip
  - move C:\projects\csgo-cli\downloads\curl-7.73.0-win64-mingw\bin C:\projects\csgo-cli\downloads\curl
  - rmdir /S /Q C:\projects\csgo-cli\downloads\curl-7.73.0-win64-mingw
  - C:\projects\csgo-cli\downloads\curl\curl.exe --version
  - cd C:\projects\csgo-cli
  # 3) Cert for cURL (cacert.pem - "https://curl.haxx.se/ca/cacert.pem")
  - mkdir dependencies\curl
  - copy C:\projects\csgo-cli\downloads\curl\curl-ca-bundle.crt C:\projects\csgo-cli\dependencies\curl\cacert.pem
  # 4) SW SDK (prebuild libs + src)
  - 7z x C:\projects\csgo-cli\downloads\sw_sdk_150.zip -aoa -y -oC:\projects\csgo-cli\dependencies -p%SW_SDK_SECRET%
  - cd C:\projects\csgo-cli\dependencies
  - ren sdk sw_sdk
  - cd C:\projects\csgo-cli
  # 5) VCPKG
  #- vcpkg install --feature-flags=manifests
  #- vcpkg integrate install

before_build:
  # CHECK: output content of folder, to see if everything is present
  - dir C:\projects\csgo-cli\downloads\
  - dir C:\projects\csgo-cli\dependencies\
  - dir C:\projects\csgo-cli\dependencies\csgo-protobufs
  # return
  - cd C:\projects\csgo-cli

build_script:
  - cmake -G "Visual Studio 16 2019" -A x64 -DCMAKE_TOOLCHAIN_FILE=C:/Tools/vcpkg/scripts/buildsystems/vcpkg.cmake .
  - msbuild C:\projects\csgo-cli\csgo_cli.sln /m /p:Configuration=Release /p:Platform=x64 /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"

after_build:
  # 1) prepare packaging for csgo-cli
  # 1.1) check release folder
  - dir C:\projects\csgo-cli\build\
  - dir C:\projects\csgo-cli\build\Release\
  # 1.2) copy stuff from release to build folder and remove release folder
  - copy C:\projects\csgo-cli\build\Release\*.* C:\projects\csgo-cli\build
  - cd C:\projects\csgo-cli\build
  - rmdir /s /q Release
  # 1.3) rename build folder to csgo-cli
  - cd C:\projects\csgo-cli
  - ren build csgo-cli
  # 1.4) CHECK: output content of folder, to see if everything is present
  - dir C:\projects\csgo-cli\csgo-cli\
  # 2) package
  - 7z a csgo-cli.zip csgo-cli
  # 3) test csgo-cli
  - C:\projects\csgo-cli\csgo-cli\csgo_cli.exe -V
  - C:\projects\csgo-cli\csgo-cli\csgo_cli.exe -help
  # 4) package dependencies folder
  - cd C:\projects\csgo-cli\dependencies
  # 4.1) delete unecrypted sw_sdk folder
  - rmdir /S /Q sw_sdk
  # 4.2) copy password protected sw_sdk_{version}.zip
  - mkdir C:\projects\csgo-cli\dependencies\sw_sdk
  - copy C:\projects\csgo-cli\downloads\sw_sdk_150.zip C:\projects\csgo-cli\dependencies\sw_sdk
  # 4.3) package dependencies folder
  - dir C:\projects\csgo-cli\dependencies
  - cd C:\projects\csgo-cli
  - 7z a csgo-cli-deps.zip C:\projects\csgo-cli\dependencies\

artifacts:
  - path: csgo-cli.zip
    name: csgo-cli
  - path: csgo-cli-deps.zip
    name: csgo-cli-deps

#deploy: